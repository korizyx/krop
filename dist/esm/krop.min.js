import{request as t}from"http";import{Agent as e,request as o}from"https";import{constants as s,connect as n}from"http2";import r from"assert";const{HTTP2_HEADER_PATH:i,HTTP2_HEADER_METHOD:a,HTTP2_HEADER_SCHEME:p,HTTP2_HEADER_AUTHORITY:c}=s;const h=new class{constructor(){this.midia_types=["image","video","audio","font"]}proxyParse(t){var e=t;const o=e.split("://")[0];e.includes("@")?e=e.substring(e.lastIndexOf("@")+1):e.includes("://")&&(e=e.split("://")[1]);const s=e.split(":")[0],n=parseInt(e.split(":")[1]);e=t.split("://")[1],e=t.substring(0,t.lastIndexOf("@"));const[r,i]=e.split(":");return{host:s,port:n,protocol:o||"https",username:r,password:i}}proxyTunnel(e,o,s={},n=15e3){return new Promise(((r,i)=>{const a=new URL(e),p="object"==typeof o?o:this.proxyParse(o);p.username&&(s["Proxy-Authorization"]="Basic "+Buffer.from(p.username+":"+p.password).toString("base64")),t({host:p.host,port:p.port,method:"CONNECT",maxVersion:"TLSv1.3",path:`${a.hostname}:${a.port?a.port:443}`,timeout:n,headers:s}).on("connect",((t,e)=>{200==t.statusCode?r(e):i(t)})).on("error",(t=>i(t))).on("timeout",(t=>i("timeout to connect in proxy"))).end()}))}parseResponseData(t,e){const o=Buffer.concat(t);var s;try{s=JSON.parse(o.toString())}catch(t){s=e["content-type"]&&this.midia_types.some((t=>e["content-type"].includes(t)))?o:o.toString()}return s}async parseOptions(t={}){const o=new URL(t.url),n=Buffer.from("object"==typeof t.payload?JSON.stringify(t.payload):"string"!=typeof t.payload&&t.payload?String(t.payload):t.payload||"");return t.http2?(t.proxy&&(t.socket=await this.proxyTunnel(t.url,t.proxy)),{url:t.url,payload:n,client:{maxVersion:"TLSv1.3",ALPNProtocols:["h2","http/1.1"],socket:t.socket},request:{[c]:o.host,[i]:o.pathname+o.search||"/",[p]:o.protocol.split(":")[0],[a]:s[`HTTP2_METHOD_${t.method?.toUpperCase()}`],"Content-Type":"text/plain","Content-Length":n.length,Accept:"*/*, image/*",...t?.headers}}):(t.proxy?t.agent=new e({socket:await this.proxyTunnel(t.url,t.proxy).catch((t=>{throw t})),keepAlive:!0}):t.agent=new e(t),{url:t.url,payload:n,request:{origin:o.origin,href:o.href,protocol:o.protocol||"https:",hostname:o.hostname,path:o.pathname+o.search||"/",port:o.port||443,method:t.method?.toUpperCase()||"GET",maxVersion:"TLSv1.3",timeout:t.timeout||15e3,headers:{accept:"application/json, text/plain, image/*, */*","accept-language":"en-US,en;q=0.9","Content-Length":n.length,...t?.headers},...t}})}};const{HTTP2_HEADER_STATUS:l}=s;function u(...e){const s=e.find((t=>"string"==typeof t))||"",r=e.find((t=>"object"==typeof t))||{};return r?.url||(r.url=s),!r.url.includes("http:")&&!r.url.includes("https:")&&(r.url=`https://${r.url}`),r.http2?function(t){return new Promise((async e=>{const o=await h.parseOptions(t),s=n(new URL(o.url),o.client),r=s.request(o.request);r.once("response",(t=>{const o=[];r.on("data",(t=>{o.push(t)})),r.once("error",console.log),r.on("end",(async()=>{r.destroy(),s.destroy(),e({status:t[l],headers:t,data:Buffer.concat(o)})}))})),o.payload?.length>0&&r.write(o.payload),r.readableEnded||r.end()}))}(r):r.url.includes("http:")?function(e={}){return new Promise((async(o,s)=>{const n=await h.parseOptions(e);delete n.request.agent,443==n.request.port&&delete n.request.port;const r=t(n.request,(t=>{const e=[];t.on("data",(t=>{e.push(t)})),t.on("end",(()=>{t.status=t.statusCode,t.data=h.parseResponseData(e,t.headers),o(t)}))})).on("error",(t=>{s(t)}));n.payload?.length>0&&r.write(n.payload),r.end()}))}(r):function(t){return new Promise((async(e,s)=>{const n=await h.parseOptions(t),r=o(n.request,(t=>{const o=[];t.on("data",(t=>{o.push(t)})),t.on("end",(()=>{t.status=t.statusCode,t.data=h.parseResponseData(o,t.headers),e(t)}))})).on("error",(t=>{s(t)}));n.payload?.length>0&&r.write(n.payload),r.end()}))}(r)}class d{constructor(t={}){this.default_options=t,this.cookies=""}async req(...t){const e=t.find((t=>"string"==typeof t))||"",o=t.find((t=>"object"==typeof t))||{};o?.url||(o.url=e);const s=this.addCookiesInOptions({...this.default_options,...o,headers:{...this.default_options?.headers,...o?.headers}}),n=await u(s);try{if(n.headers["set-cookie"])if(this.cookies){const t=this.json(),e=this.json(n.headers["set-cookie"].map((t=>t.split(";")[0])).join("; ")),o={...t,...e};var r="";for(const t of Object.keys(o))r+=`${t}=${o[t]}; `;this.cookies=r.slice(0,-2)}else this.cookies=n.headers["set-cookie"].map((t=>t.split(";")[0])).join("; ")}catch(t){}return n}addCookie(t){return"object"==typeof t?!this.cookies.includes(t.name)&&(this.cookies?(this.cookies+=`; ${t.name}=${t.value}`,!0):(this.cookies=`${t.name}=${t.value}`,!0)):!this.cookies.includes(t.split("=")[0])&&(this.cookies?(this.cookies+=`; ${t.trim()}`,!0):(this.cookies=`${t.trim()}`,!0))}removeCookie(t){return!!this.cookies.includes(t)&&(this.cookies=this.cookies.replace(this.cookies.slice(this.cookies.indexOf(t)).split(" ")[0],""),!0)}addCookiesInOptions(t){return this.cookies&&(t.headers&&t.headers?.cookie?t.headers.cookie+="; "+this.cookies:t.headers.cookie=this.cookies),t}json(t){const e={};for(const o of(t||this.cookies).split("; ")){const[t,...s]=o.split("=");t&&(e[t]=s.join("="))}return e}}["get","post","patch","options","delete","head","put","link","unlink","purge"].forEach((t=>{u[t]=e=>u({...e,method:t})})),u.Session=d,r.equal(u.Session,d);const y=u;export{y as default};
//# sourceMappingURL=krop.min.js.map
