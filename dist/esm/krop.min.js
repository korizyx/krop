import{request as t}from"http";import{Agent as e,request as o}from"https";import{constants as s,connect as n}from"http2";import{gunzip as r,brotliDecompress as i,inflate as a}from"zlib";import c from"assert";const{HTTP2_HEADER_PATH:p,HTTP2_HEADER_METHOD:h,HTTP2_HEADER_SCHEME:l,HTTP2_HEADER_AUTHORITY:u}=s;const d=new class{constructor(){this.midia_types=["image","video","audio","font"]}proxyParse(t){var e=t;const o=e.split("://")[0];e.includes("@")?e=e.substring(e.lastIndexOf("@")+1):e.includes("://")&&(e=e.split("://")[1]);const s=e.split(":")[0],n=parseInt(e.split(":")[1]);e=t.split("://")[1],e=t.substring(0,t.lastIndexOf("@"));const[r,i]=e.split(":");return{host:s,port:n,protocol:o||"https",username:r,password:i}}proxyTunnel(e,o,s={},n=15e3){return new Promise(((r,i)=>{const a=new URL(e),c="object"==typeof o?o:this.proxyParse(o);c.username&&(s["Proxy-Authorization"]="Basic "+Buffer.from(c.username+":"+c.password).toString("base64")),t({host:c.host,port:c.port,method:"CONNECT",path:`${a.hostname}:${a.port?a.port:443}`,timeout:n,headers:s}).on("connect",((t,e)=>{t.statusCode<=299?r(e):i(t)})).on("error",(t=>i(t))).on("timeout",(t=>i("timeout to connect in proxy"))).end()}))}decompress(t,e){return new Promise(((o,s)=>{const n=Buffer.concat(t);e["content-encoding"]?.includes("gzip")?r(n,((t,e)=>{o(e.toString())})):e["content-encoding"]?.includes("br")?i(n,((t,e)=>{o(e.toString())})):e["content-encoding"]?.includes("deflate")?a(n,((t,e)=>{o(e.toString())})):o(n.toString())}))}async parseResponseData(t,e){var o=await this.decompress(t,e);try{o=JSON.parse(o)}catch(s){e["content-type"]&&this.midia_types.some((t=>e["content-type"].includes(t)))&&(o=Buffer.concat(t))}return o}async parseOptions(t={}){try{const o=new URL(t.url),n=Buffer.from("object"==typeof t.payload?JSON.stringify(t.payload):"string"!=typeof t.payload&&t.payload?String(t.payload):t.payload||"");return t.http2?(t.proxy&&(t.socket=await this.proxyTunnel(t.url,t.proxy)),{url:t.url,payload:n,client:{maxVersion:t?.tlsVersion||null,ALPNProtocols:["h2","http/1.1"],socket:t.socket,ciphers:t?.ciphers||null},request:{[u]:o.host,[p]:o.pathname+o.search||"/",[l]:o.protocol.split(":")[0],[h]:s[`HTTP2_METHOD_${t.method?.toUpperCase()}`],"Content-Type":"text/plain","Content-Length":n.length,Accept:"*/*, image/*",...t?.headers},__Socket:t?.socket||null}):(t.proxy?(t.__Socket=await this.proxyTunnel(t.url,t.proxy).catch((t=>{throw t})),t.agent=new e({socket:t.__Socket,keepAlive:!0})):t.agent=new e(t),{url:t.url,payload:n,request:{origin:o.origin,href:o.href,protocol:o.protocol||"https:",hostname:o.hostname,path:o.pathname+o.search||"/",port:o.port||443,method:t.method?.toUpperCase()||"GET",maxVersion:t?.tlsVersion||null,timeout:t.timeout||15e3,ciphers:t?.ciphers||null,headers:{accept:"application/json, text/plain, image/*, */*","accept-language":"en-US,en;q=0.9","Content-Length":n.length,...t?.headers},...t,__Socket:t?.__Socket||null}})}catch(t){throw t}}};const{HTTP2_HEADER_STATUS:_}=s;const y=["TLS_AES_256_GCM_SHA384","TLS_CHACHA20_POLY1305_SHA256","TLS_AES_128_GCM_SHA256","TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384","TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384","TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256","TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256","TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256","TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"].join(":");function S(...e){const s=e.find((t=>"string"==typeof t))||"",r=e.find((t=>"object"==typeof t))||{};r?.url||(r.url=s),!r.url.includes("http:")&&!r.url.includes("https:")&&(r.url=`https://${r.url}`);try{return r.http2?function(t){return new Promise((async(e,o)=>{try{const r=await d.parseOptions(t),i=n(new URL(r.url),{...r.client,peerMaxConcurrentStreams:1/0});i.on("error",o);const a=i.request({...r.request});r.payload?.length>0&&a.write(r.payload);const c=[];var s;a.once("response",(t=>{s=t})),a.on("data",(t=>{c.push(t)})),a.on("error",(t=>{o(t)})),a.on("end",(async()=>{r.__Socket&&r.__Socket.destroy(),a.destroy(),i.destroy(),e({status:s[_],headers:s,data:await d.parseResponseData(c,s)})})),a.readableEnded||a.end()}catch(t){o(t)}}))}(r):r.url.includes("http:")?function(e={}){return new Promise((async(o,s)=>{try{const n=await d.parseOptions(e);delete n.request.agent,443==n.request.port&&delete n.request.port;const r=t(n.request,(t=>{const e=[];t.on("data",(t=>{e.push(t)})),t.on("end",(async()=>{t.status=t.statusCode,t.data=await d.parseResponseData(e,t.headers),n.__Socket&&n.__Socket.destroy(),o(t)}))})).on("error",(t=>{s(t)}));n.payload?.length>0&&r.write(n.payload),r.end()}catch(t){s(t)}}))}(r):function(t){return new Promise((async(e,s)=>{try{const n=await d.parseOptions(t),r=o({...n.request},(t=>{const o=[];t.on("data",(t=>{o.push(t)})),t.on("end",(async()=>{t.status=t.statusCode,t.data=await d.parseResponseData(o,t.headers),n.request.__Socket&&n.request.__Socket.destroy(),e(t)}))})).on("error",(t=>{s(t)}));n.payload?.length>0&&r.write(n.payload),r.end()}catch(t){s(t)}}))}(r)}catch(t){if(r?.retry&&r.retry>0)return--r.retry,S(r);throw t}}S.BETTER_CIPHERS=y;class m{constructor(t={}){this.default_options=t,this.cookies=""}async req(...t){try{const o=t.find((t=>"string"==typeof t))||"",s=t.find((t=>"object"==typeof t))||{};s?.url||(s.url=o);const n=this.addCookiesInOptions({...this.default_options,...s,headers:{...this.default_options?.headers,...s?.headers}}),r=await S(n);try{if(r.headers["set-cookie"])if(this.cookies){const t=this.json(),o=this.json(r.headers["set-cookie"].map((t=>t.split(";")[0])).join("; ")),s={...t,...o};var e="";for(const t of Object.keys(s))e+=`${t}=${s[t]}; `;this.cookies=e.slice(0,-2)}else this.cookies=r.headers["set-cookie"].map((t=>t.split(";")[0])).join("; ")}catch(t){throw t}return r}catch(t){throw t}}addCookie(t){return"object"==typeof t?!this.cookies.includes(t.name)&&(this.cookies?(this.cookies+=`; ${t.name}=${t.value}`,!0):(this.cookies=`${t.name}=${t.value}`,!0)):!this.cookies.includes(t.split("=")[0])&&(this.cookies?(this.cookies+=`; ${t.trim()}`,!0):(this.cookies=`${t.trim()}`,!0))}removeCookie(t){return!!this.cookies.includes(t)&&(this.cookies=this.cookies.replace(this.cookies.slice(this.cookies.indexOf(t)).split(" ")[0],""),!0)}addCookiesInOptions(t){return this.cookies&&(t.headers&&t.headers?.cookie?t.headers.cookie+="; "+this.cookies:t.headers.cookie=this.cookies),t}json(t,e=!0){const o={};for(const s of(t||this.cookies).split("; ")){const[t,...n]=s.split("=");t&&(o[t]=e?encodeURIComponent(n.join("=")):n.join("="))}return o}}["get","post","patch","options","delete","head","put","link","unlink","purge"].forEach((t=>{S[t]=e=>S({...e,method:t})})),S.Session=m,c.equal(S.Session,m);const f=S;export{f as default};
//# sourceMappingURL=krop.min.js.map
